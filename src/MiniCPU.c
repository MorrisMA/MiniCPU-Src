/*
 ============================================================================
 Name        : MiniCPU.c
 Author      : Michael A. Morris
 Version     :
 Copyright   : Copyright 2016 - GPLv3
 Description : Hello World in C, Ansi-style
 ============================================================================
 */

#include <stdio.h>
#include <stdlib.h>

#include "MiniCPU.h"
#include "cpu_model.h"

//extern void cpu_model(CPU *p, unsigned char *ram);

////////////////////////////////////////////////////////////////////////////////

int main(int argc, char* argv[])
{
	CPU cpu;

    unsigned char   rom[PML] = {0x0F, 0x3C, 0x21, 0x0F, 0x3F, 0x22, 0x30, 0x63,
                                0x62, 0x61, 0x31, 0x60, 0x01, 0x37, 0x10, 0x6F,
                                0x10, 0x4F, 0xA3, 0x24, 0x11, 0xCA, 0x21, 0x30,
                                0x21, 0x24, 0x27, 0x10, 0xDE, 0x10, 0x6F, 0x44,
                                0x21, 0x42, 0x24, 0x26, 0x60, 0x45, 0x21, 0x43,
                                0x26, 0x61, 0x24, 0x11, 0xC3, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

    unsigned char   ram[DML] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
                                0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 };

    // Initialize CPU state

    cpu.ma = 0; cpu.io = 0;
    cpu.ip = 0;
    cpu.xp = 0; cpu.yp = 0; cpu.ys = 0;
    cpu.ki = 0; cpu.ir = 0;
    cpu.ra = 0; cpu.rb = 0; cpu.cy = 0;
    cpu.clr_ki = 0; cpu.ld_kil = 0; cpu.ld_kih = 0; cpu.ld_vec = 0;

    // Fetch and execute program continuously

    while(1) {
        printf("ma: %04X;", cpu.ma);

        // Perform program memory fetch operation

        cpu.io = rom[cpu.ma % PML];

        // Call processor model

        cpu_model(&cpu, ram);

        // Print out remainder of the processor state

        printf(" io: %02X;", cpu.io);

        printf(" ki: %04X; ir: %02X; ip: %04X",
               cpu.ki,
               cpu.ir,
               cpu.ip                           );
        printf(" xp: %04X; yp: %04X; ys: %04X",
               cpu.xp,
               cpu.yp,
               cpu.ys                           );
        printf(" ra: %02X; rb: %02X; cy: %d\n",
               cpu.ra,
               cpu.rb,
               cpu.cy                           );
    }

	return 0;
}

